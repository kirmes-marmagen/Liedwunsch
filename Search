<!doctype html>
let payload = {
event_code: url.searchParams.get('e'),
requester_name: name || null,
table_label: table || null,
status: 'neu',
...base
};
if (!base || base.platform === undefined){
// Nur Link genutzt
payload = { ...payload, platform: 'link', track_url: link || null, track_title: 'Link‑Wunsch', artist: null };
} else if (link){
payload.track_url = link; // zusätzlich
}


const { error } = await client.from('song_requests').insert(payload);
if (error){ alert('Fehler beim Senden: ' + error.message); return; }
document.getElementById('query').value='';
document.getElementById('link').value='';
}


// Letzte Wünsche (rechts im Gast‑Bereich)
async function loadLatest(){
const { data, error } = await client
.from('song_requests')
.select('*')
.eq('event_code', url.searchParams.get('e'))
.order('created_at', { ascending: false })
.limit(10);
if (error) return;
const latest = document.getElementById('latest');
latest.innerHTML = '';
(data||[]).forEach(row => latest.appendChild(renderRow(row)));
}


function renderRow(row){
const div = document.createElement('div');
div.className = 'row';
const meta = [row.artist, row.track_title].filter(Boolean).join(' — ');
div.innerHTML = `<div><div><strong>${meta || row.track_url || 'Wunsch'}</strong></div><div class='muted small'>${new Date(row.created_at).toLocaleTimeString()} • ${row.platform}${row.table_label? ' • Tisch '+row.table_label:''}${row.requester_name? ' • '+row.requester_name:''}</div></div>`;
return div;
}


// DJ‑Liste
const statusFilter = document.getElementById('statusFilter');
statusFilter.onchange = loadDj;


async function loadDj(){
const q = client
.from('song_requests')
.select('*')
.eq('event_code', url.searchParams.get('e'))
.order('created_at', { ascending: true });
const status = statusFilter.value;
const { data, error } = status ? await q.eq('status', status) : await q;
if (error) return;
const list = document.getElementById('list');
list.innerHTML = '';
(data||[]).forEach(row => {
const item = renderRow(row);
const controls = document.createElement('div');
controls.style.display = 'flex';
controls.style.gap = '6px';
['neu','wartet','gespielt'].forEach(s => {
const b = document.createElement('button');
b.className = 'badge';
b.textContent = s;
b.onclick = async () => { await client.from('song_requests').update({ status: s }).eq('id', row.id); };
controls.appendChild(b);
});
item.appendChild(controls);
list.appendChild(item);
});
}


// Realtime Updates
client.channel('rq')
.on('postgres_changes', { event: '*', schema: 'public', table: 'song_requests' }, payload => { loadLatest(); loadDj(); })
.subscribe();


loadLatest();
loadDj();
</script>
</body>
</html>
